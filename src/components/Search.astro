---
import "@pagefind/default-ui/css/ui.css";
---

<button
    id="search-trigger"
    aria-label="Open Search"
    class="text-slate-600 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
>
    <!-- Magnifying Glass Icon -->
    <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="w-6 h-6"
    >
        <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
        ></path>
    </svg>
</button>

<!-- Search Modal -->
<dialog
    id="search-modal"
    class="backdrop:bg-slate-900/80 bg-transparent p-0 w-full max-w-2xl text-left rounded-xl shadow-2xl open:animate-fade-in"
>
    <div
        class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800"
    >
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white">
                Ask Steve
            </h3>
            <button
                id="close-search"
                class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"
            >
                <!-- X Icon -->
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                    class="w-6 h-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="search"></div>
    </div>
</dialog>

<script is:inline>
    const initSearchModal = () => {
        const trigger = document.getElementById("search-trigger");
        const dialog = document.getElementById("search-modal");
        const closeBtn = document.getElementById("close-search");
        const searchDiv = document.getElementById("search");

        if (!trigger || !dialog || !closeBtn) return;

        // Open
        trigger.addEventListener("click", () => {
            // @ts-ignore
            dialog.showModal();
            // Initialize Pagefind only when opened for the first time
            if (searchDiv && searchDiv.innerHTML === "") {
                const initSearch = async () => {
                    const { PagefindUI } = await import("@pagefind/default-ui");
                    new PagefindUI({
                        element: "#search",
                        showSubResults: true,
                        showImages: false,
                        translations: {
                            placeholder:
                                "Ask Steve... (e.g. Budget, Leadership)",
                            zero_results:
                                "No insights found for [SEARCH_TERM].",
                        },
                    });
                    // Focus input
                    setTimeout(() => {
                        const input = dialog.querySelector("input");
                        if (input) input.focus();
                    }, 100);
                };
                initSearch();
            }
        });

        // Close
        closeBtn.addEventListener("click", () => {
            // @ts-ignore
            dialog.close();
        });

        // Close on backdrop click
        dialog.addEventListener("click", (e) => {
            const rect = dialog.getBoundingClientRect();
            const isInDialog =
                rect.top <= e.clientY &&
                e.clientY <= rect.top + rect.height &&
                rect.left <= e.clientX &&
                e.clientX <= rect.left + rect.width;
            if (!isInDialog) {
                // @ts-ignore
                dialog.close();
            }
        });
    };

    // Run on load and after transitions
    window.addEventListener("DOMContentLoaded", initSearchModal);
    document.addEventListener("astro:page-load", initSearchModal);
</script>

<style is:global>
    /* Customize Pagefind to match site theme */
    :root {
        --pagefind-ui-scale: 0.8;
        --pagefind-ui-primary: #3b82f6; /* slate-900 or blue-500 */
        --pagefind-ui-text: #334155; /* slate-700 */
        --pagefind-ui-background: #ffffff;
        --pagefind-ui-border: #e2e8f0; /* slate-200 */
        --pagefind-ui-tag: #f1f5f9;
        --pagefind-ui-border-width: 1px;
        --pagefind-ui-border-radius: 8px;
        --pagefind-ui-image-border-radius: 8px;
        --pagefind-ui-image-box-ratio: 3 / 2;
        --pagefind-ui-font: sans-serif;
    }

    .dark {
        --pagefind-ui-primary: #60a5fa; /* blue-400 */
        --pagefind-ui-text: #cbd5e1; /* slate-300 */
        --pagefind-ui-background: #0f172a; /* slate-950 */
        --pagefind-ui-border: #1e293b; /* slate-800 */
        --pagefind-ui-tag: #1e293b;
    }

    /* Minimalist Input */
    .pagefind-ui__search-input {
        background-color: #f8fafc !important; /* slate-50 */
        border-color: #e2e8f0 !important; /* slate-200 */
        color: #334155 !important; /* slate-700 */
    }
    :global(.dark) .pagefind-ui__search-input {
        background-color: #0f172a !important; /* slate-950 */
        border-color: #1e293b !important; /* slate-800 */
        color: #cbd5e1 !important; /* slate-300 */
    }

    /* Hide some default UI elements for cleaner look */
    .pagefind-ui__result-thumb {
        display: none !important;
    }
</style>
