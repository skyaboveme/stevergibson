---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
    const posts = await getCollection("blog");
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: post,
    }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content } = await post.render();

const schema = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: post.data.title,
    description: post.data.description,
    image: post.data.heroImage
        ? new URL(post.data.heroImage, Astro.site).toString()
        : new URL("/images/stevergibsoncareer.jpg", Astro.site).toString(),
    author: {
        "@type": "Person",
        name: "Steve R Gibson",
        url: "https://stevergibson.com",
    },
    publisher: {
        "@type": "Person",
        name: "Steve R Gibson",
        logo: {
            "@type": "ImageObject",
            url: "https://stevergibson.com/SteveRGibsonlogo.png",
        },
    },
    datePublished: post.data.pubDate.toISOString(),
    dateModified: post.data.pubDate.toISOString(),
};
---

<BaseLayout title={post.data.title} description={post.data.description}>
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <!-- Reading Progress Bar -->
    <div
        class="fixed top-0 left-0 w-full z-50 h-1 bg-transparent pointer-events-none"
    >
        <div
            id="reading-progress"
            class="h-full bg-blue-600 w-0 transition-all duration-150 ease-out"
        >
        </div>
    </div>

    <article class="max-w-3xl mx-auto py-8 relative">
        <header class="mb-10 text-center">
            <div class="text-sm text-slate-500 mb-4">
                <time datetime={post.data.pubDate.toISOString()}>
                    {
                        post.data.pubDate.toLocaleDateString("en-us", {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })
                    }
                </time>
            </div>
            <h1
                class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-6 leading-tight"
            >
                {post.data.title}
            </h1>
            {
                post.data.heroImage && (
                    <img
                        width={1020}
                        height={510}
                        src={post.data.heroImage}
                        alt={post.data.title}
                        class="w-full h-auto rounded-xl shadow-lg mt-8"
                    />
                )
            }
        </header>
        <div
            class="prose prose-lg dark:prose-invert mx-auto text-slate-700 dark:text-slate-300"
        >
            <Content />
        </div>
    </article>
</BaseLayout>

<script>
    document.addEventListener("astro:page-load", () => {
        const progressBar = document.getElementById("reading-progress");
        const article = document.querySelector("article");

        if (progressBar && article) {
            const updateProgress = () => {
                const totalHeight = article.clientHeight - window.innerHeight;
                const progress = (window.scrollY / totalHeight) * 100;
                progressBar.style.width = `${Math.min(Math.max(progress, 0), 100)}%`;
            };

            window.addEventListener("scroll", updateProgress);
            updateProgress(); // Initial check
        }
    });
</script>
